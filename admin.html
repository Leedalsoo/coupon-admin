<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>관리자 시스템</title>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Noto Sans KR', sans-serif;
      background-color: #f5f5f5;
      font-size: 14px;
    }

    /* 로그인 스타일 */
    .login-container {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      background-color: #f5f5f5;
    }

    .login-form {
      background: white;
      padding: 2rem;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      width: 100%;
      max-width: 400px;
    }

    .form-group {
      margin-bottom: 1rem;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
    }

    .form-input {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 1rem;
    }

    .login-btn {
      width: 100%;
      padding: 0.75rem;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 500;
    }

    /* 대시보드 스타일 */
    .dashboard {
      padding: 0;
      min-height: 100vh;
      display: none;
    }

    .dashboard-header {
      background: #fff;
      padding: 0.5rem;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      position: fixed;
      width: 100%;
      top: 0;
      z-index: 100;
      height: auto;
    }

    .menu-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 0.5rem;
    }

    .main-menu {
      display: flex;
      gap: 1rem;
      align-items: center;
      flex: 3;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    .main-menu::-webkit-scrollbar {
      display: none;
    }

    .menu-btn {
      padding: 0.3rem 0.65rem !important;
      font-size: 0.8rem !important;
      border: none;
      background: #f0f1f1;
      /* 부드러운 푸른색으로 변경 (예: 부드러운 하늘색) */
      cursor: pointer;
      border-radius: 3px;
      margin-right: 0.3rem;
      white-space: nowrap;
    }

    .menu-btn.active {
      background: #007bff;
      color: white;
    }

    .menu-btn:hover {
      background: #f0f0f0;
    }

    .menu-btn.active:hover {
      background: #0056b3;
    }

    /* 사용자 액션 버튼 */
    .user-actions {
      display: flex;
      gap: 0.3rem;
    }

    .user-btn {
      padding: 0.5rem 0.8rem;
      font-size: 0.8rem;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      background: #f8f9fa;
      color: #333;
      display: flex;
      align-items: center;
      gap: 0.2rem;
    }

    .export-btn {
      background-color: #28a745;
      color: white;
    }

    .export-btn i {
      font-size: 0.7rem;
    }

    .logout-btn {
      background-color: #dc3545;
      color: white;
    }

    .change-pw-btn {
      background-color: #16f154;
      color: rgb(254, 255, 252);
    }

    /* 대시보드 컨텐츠 */
    .dashboard-content {
      margin-top: 70px;
      padding: 1.5rem;
      height: calc(100vh - 70px);
      overflow: hidden;
      position: relative;
    }

    .content-section {
      display: none;
    }

    .content-section.active {
      display: block;
    }

    /* 테이블 스타일 */
    .data-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      table-layout: auto;  /* 컬럼 너비 자동 조정 */
    }

    .data-table th {
      position: sticky;
      top: 0;
      background: #f8f9fa;
      z-index: 10;
      padding: 0.25rem;  /* 모든 방향 0.25rem 여백 */
      font-size: 0.65rem;
      border-bottom: 1px solid #dee2e6;
    }

    .data-table td {
      padding: 0.4rem 0.5rem;  /* 상하 0.4rem, 좌우 0.5rem 여백 */
      font-size: 0.56rem;
      border-bottom: 1px solid #eee;
      white-space: nowrap;
      height: auto;
      line-height: 1.2;
      vertical-align: middle;
    }

    /* 마지막 칼럼의 오른쪽 테두리 제거 */
    .data-table td:last-child {
      border-right: none;
    }

    /* 짝수 행 배경색 지정 */
    .data-table tr:nth-child(even) {
      background-color: #f8f9fa;
    }

    /* 행 호버 효과 */
    .data-table tr:hover {
      background-color: #e9ecef;
    }

    /* 금액 칼럼 우측 정렬 유지 */
    .amount-cell {
      text-align: right !important;
      padding-right: 1rem !important;  /* 우측 여백 추가 */
    }

    /* 상태 배지 */
    .status-badge {
      height: 20px;  /* 높이를 20px로 설정 */
      line-height: 10px;  /* 텍스트 수직 가운데 정렬 */
      padding: 0 0.65rem;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      box-sizing: border-box;
    }

    .status-pending {
      background: #fff3cd;
      color: #856404;
    }

    .status-approved {
      background: #d4edda;
      color: #155724;
    }

    .status-rejected {
      background: #f8d7da;
      color: #721c24;
    }

    /* 액션 버튼 */
    .action-btn {
      padding: 0.15rem 0.3rem;
      font-size: 0.56rem;
      margin-right: 0.2rem;
      line-height: 1;
    }

    .approve-btn {
      background: #28a745;
      color: white;
    }

    .reject-btn {
      background: #dc3545;
      color: white;
    }

    .reset-btn {
      background: #6c757d;
      color: white;
    }

    .action-btn:hover {
      opacity: 0.9;
    }

    /* 모달 스타일 */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
    }

    .modal-content {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 2rem;
      border-radius: 8px;
      width: 90%;
      max-width: 400px;
    }

    .close-btn {
      position: absolute;
      right: 1rem;
      top: 1rem;
      border: none;
      background: none;
      font-size: 1.5rem;
      cursor: pointer;
    }

    .section-title {
      font-size: 1.1rem;
      margin: 0 0 1.2rem 0;
      padding: 0;
      height: 30px;
    }

    .export-btn {
      background-color: #28a745;
      color: white;
      display: flex;
      align-items: center;
      gap: 0.3rem;
    }

    .export-btn i {
      font-size: 0.9rem;
    }

    .export-btn:hover {
      background-color: #218838;
    }

    @media (max-width: 768px) {
      .menu-container {
        flex-direction: column;
        gap: 1rem;
      }

      .main-menu {
        width: 100%;
        justify-content: flex-start;
      }

      .user-actions {
        width: 100%;
        justify-content: center;
      }

      .menu-btn {
        padding: 0.4rem 0.7rem;
        font-size: 0.63rem;
      }

      .user-btn {
        padding: 0.35rem 0.56rem;
        font-size: 0.56rem;
      }

      .dashboard-content {
        margin-top: 120px;
        height: calc(100vh - 120px);
        padding: 1rem;
      }

      .table-container {
        margin-top: 1rem;
        height: calc(100% - 100px);
      }

      .data-table td,
      .data-table th {
        padding: 0.3rem 0.4rem;
        font-size: 0.53rem;
      }
    }

    /* 터치 디바이스 최적화 */
    @media (hover: none) {

      .menu-btn:hover,
      .user-btn:hover {
        opacity: 1;
      }
    }

    /* 반응형 및 터치 관련 스타일 */
    body {
      touch-action: pan-x pan-y;
      overflow-x: hidden;
      -webkit-overflow-scrolling: touch;
      touch-action: pinch-zoom;
    }

    .dashboard-header {
      background: #fff;
      padding: 1rem;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      position: fixed;
      width: 100%;
      top: 0;
      z-index: 100;
      height: auto;
    }

    .menu-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 1rem;
    }

    .main-menu {
      display: flex;
      gap: 1rem;
      align-items: center;
      flex: 3;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    .main-menu::-webkit-scrollbar {
      display: none;
    }

    .user-actions {
      display: flex;
      flex-direction: row;
      gap: 0.5rem;
      flex: 1;
      justify-content: flex-end;
    }

    .menu-btn {
      padding: 0.8rem 1.2rem;
      white-space: nowrap;
      font-size: 1rem;
    }

    .user-btn {
      padding: 0.6rem 1rem;
      font-size: 0.9rem;
    }

    .dashboard-content {
      margin-top: 70px;
      padding: 1rem;
      max-width: 1400px;
      margin-left: auto;
      margin-right: auto;
      overflow-x: hidden;
    }

    .table-container {
      margin-top: 1rem;
      overflow: auto;
      -webkit-overflow-scrolling: touch;
      position: relative;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .data-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
    }

    .data-table thead {
      position: sticky;
      top: 0;
      z-index: 1;
      background: #f8f9fa;
    }

    /* 반응형 미디어 쿼리 */
    @media (max-width: 768px) {
      .menu-container {
        flex-direction: column;
        gap: 1rem;
      }

      .main-menu {
        width: 100%;
        justify-content: flex-start;
      }

      .user-actions {
        width: 100%;
        justify-content: center;
      }

      .menu-btn {
        padding: 0.6rem 1rem;
        font-size: 0.9rem;
      }

      .user-btn {
        padding: 0.5rem 0.8rem;
        font-size: 0.8rem;
      }

      .dashboard-content {
        margin-top: 120px;
        padding: 0.5rem;
      }

      .data-table th,
      .data-table td {
        padding: 0.8rem;
        font-size: 0.9rem;
      }
    }

    /* 터치 디바이스 최적화 */
    @media (hover: none) {

      .menu-btn:hover,
      .user-btn:hover {
        opacity: 1;
      }
    }

    .reset-btn {
      background: #6c757d;
      color: white;
    }

    .action-btn {
      margin-right: 0.3rem;
      margin-bottom: 0.3rem;
    }

    /* 테이블 컨테이너 스크롤 설정 */
    .dashboard-content {
      margin-top: 60px;
      height: calc(100vh - 60px);
      overflow: hidden;
      position: relative;
      padding: 1rem;
    }

    .table-container {
      height: calc(100% - 100px);
      overflow-y: auto;
      border-radius: 8px;
      background: white;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    /* 테이블 전체 레이아웃 조정 */
    .data-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
    }

    .data-table th {
      /* 테이블의 칼럼 제목 글자크기 및 칼럼내부여백조정 */
      position: sticky;
      top: 0;
      background: #f8f9fa;
      z-index: 10;
      padding: 0.25rem;
      font-size: 0.65rem;
      border-bottom: 1px solid #dee2e6;
    }

    .data-table td {
      /* 테이블내부의 데이터 글자크기 및 칼럼내부여백조정 */
      padding: 0.4rem 0.5rem;
      font-size: 0.56rem;
      border-bottom: 1px solid #eee;
      white-space: nowrap;
      height: auto;
      line-height: 1.2;
      vertical-align: middle;
    }

    .data-table tr:hover {
      background-color: #f8f9fa;
    }

    /* 상태 배지 여백 조정 */
    .status-badge {
      padding: 0.15rem 0.3rem;
      font-size: 0.56rem;
      display: inline-block;
      line-height: 1;
    }

    /* 액션 버튼 여백 조정 */
    .action-btn {
      padding: 0.15rem 0.3rem;
      font-size: 0.56rem;
      margin-right: 0.2rem;
      line-height: 1;
    }

    /* 섹션(환불신청관리,쿠폰사용신청관리,등등) 제목 여백 조정 */
    .section-title {
      font-size: 1.1rem;
      margin: 0 0 1.2rem 0;
      padding: 0;
      height: 20px;
      /*제목이 포함된 높이를 조정할 수 있어 */
    }

    /* 반응형 조정 */
    @media (max-width: 768px) {
      .dashboard-header {
        height: auto;
      }

      .dashboard-content {
        margin-top: 100px;
        height: calc(100vh - 100px);
      }

      .data-table td,
      .data-table th {
        padding: 0.3rem 0.4rem;
        font-size: 0.53rem;
      }
    }

    /* 스크롤바 스���일��� */
    .table-container::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }

    .table-container::-webkit-scrollbar-track {
      background: #f1f1f1;
    }

    .table-container::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 3px;
    }

    .table-container::-webkit-scrollbar-thumb:hover {
      background: #555;
    }

    /* 버튼 호버 효과 */
    .user-btn:hover {
      opacity: 0.9;
    }

    /* 스크롤바 숨김 (메인 메뉴) */
    .main-menu::-webkit-scrollbar {
      height: 3px;
    }

    .main-menu::-webkit-scrollbar-thumb {
      background: #ddd;
      border-radius: 3px;
    }

    .amount-cell {
      text-align: right;
      font-family: 'Courier New', monospace;
      white-space: nowrap;
    }

    /* 환불금액 요약 박스 스타일 */
    .refund-summary-box {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      padding: 0.5rem;
      margin: 0 1rem;
      font-size: 0.75rem;
      min-width: 200px;
    }

    .summary-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
    }

    .summary-row:first-child {
      margin-bottom: 0.3rem;
      padding-bottom: 0.3rem;
      border-bottom: 1px solid #dee2e6;
    }

    .summary-label {
      color: #495057;
      font-weight: 500;
    }

    /* 날짜별 금액 데이터 우측 정렬 */
    .summary-value {
      color: #007bff;
      font-weight: 600;
      font-family: 'Courier New', monospace;
      text-align: right !important;  /* 우측 정렬 */
    }

    .date-selector {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      width: 100%;
    }

    .date-selector input[type="date"] {
      padding: 0.25rem;
      border: 1px solid #ced4da;
      border-radius: 3px;
      font-size: 0.75rem;
      width: 120px;
    }

    /* 반응형 스타일 수정 */
    @media (max-width: 768px) {
      .menu-container {
        flex-wrap: wrap;
      }

      .refund-summary-box {
        order: 2;
        width: 100%;
        margin: 0.5rem 0;
      }

      .user-actions {
        order: 3;
        width: 100%;
        justify-content: flex-end;
      }
    }

    /* 삭제 버튼 스타일 */
    .delete-btn {
      background: #dc3545;
      color: white;
      margin-left: 0.3rem;
    }

    .delete-btn:hover {
      background: #c82333;
    }

    /* 액션 버튼 컨테이너 */
    .action-buttons {
      display: flex;
      gap: 0.3rem;
      align-items: center;
      justify-content: flex-start;
    }

    /* 액션 버튼 공통 스타일 */
    .action-btn {
      padding: 0.3rem 0.6rem;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      font-size: 0.75rem;
      white-space: nowrap;
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
    }

    /* 승인 버튼 */
    .approve-btn {
      background: #28a745;
      color: white;
    }

    /* 반려 버튼 */
    .reject-btn {
      background: #dc3545;
      color: white;
    }

    /* 삭제 버튼 */
    .delete-btn {
      background: #6c757d;
      color: white;
      padding: 0.3rem 0.5rem;
    }

    /* 버튼 호버 효과 */
    .action-btn:hover {
      opacity: 0.9;
    }

    /* 아이콘 스타일 */
    .action-btn i {
      font-size: 0.8rem;
    }

    /* 헤더 부분에 다음 CSS 스타일 추가 */
    .action-buttons {
      display: flex;
      gap: 0.3rem;
      justify-content: flex-start;
      align-items: center;
    }

    .action-btn {
      padding: 0.3rem 0.6rem;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      font-size: 0.75rem;
      white-space: nowrap;
    }

    .approve-btn {
      background: #28a745;
      color: white;
    }

    .reject-btn {
      background: #dc3545;
      color: white;
    }

    .delete-btn {
      background: #6c757d;
      color: white;
      padding: 0.3rem;
    }

    .action-btn:hover {
      opacity: 0.8;
    }

    /* 상태 뱃지 스타일 */
    .status-badge {
      padding: 0.25rem 0.5rem;
      border-radius: 3px;
      font-size: 0.75rem;
      white-space: nowrap;
    }

    .status-pending {
      background: #ffc107;
      color: #000;
    }

    .status-approved {
      background: #28a745;
      color: white;
    }

    .status-rejected {
      background: #dc3545;
      color: white;
    }

    /* 테이블 셀 스타일 */
    .data-table td {
      padding: 0.5rem;
      vertical-align: middle;
    }

    .data-table td:last-child {
      min-width: 120px;
    }

    /* 송금완료 버튼 스타일 */
    .complete-btn {
      background: #17a2b8;
      color: white;
    }

    /* 환불처리완료 상태 배지 스타일 */
    .status-completed {
      background: #17a2b8;
      color: white;
    }

    /* 취소 상태 배지 스타일 추가 */
    .status-cancelled {
      background: #6c757d;
      color: white;
    }

    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 40px;
      height: 20px;
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 20px;
    }

    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 16px;
      width: 16px;
      left: 2px;
      bottom: 2px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }

    input:checked+.toggle-slider {
      background-color: #2196F3;
    }

    input:checked+.toggle-slider:before {
      transform: translateX(20px);
    }

    /* 숨김 행 스타일 수정 - 토글 스위치 칼럼은 제외 */
    .hidden-row td:not(:last-child) {
      display: none;
    }

    .hidden-row td:last-child {
      display: table-cell;
      border-bottom: 1px solid #eee;
    }

    /* 전자서명 관련 스타일 */
    .signature-thumbnail {
      width: 30px;           /* 행 높이와 동일하게 설정 */
      height: 30px;          /* 행 높이와 동일하게 설정 */
      object-fit: contain;   /* 이미지 비율 유지하면서 컨테이너에 맞춤 */
      vertical-align: middle;
      cursor: pointer;       /* 클릭 가능 표시 */
    }

    /* 모달에서 보여지는 원본 이미지 스타일 유지 */
    .signature-image {
      max-width: 100%;
      height: auto;
      margin: 1rem 0;
    }

    .search-container {
      margin-bottom: 1rem;
      display: flex;
      gap: 0.5rem;
    }

    #signatureSearch {
      flex: 1;
      padding: 0.5rem;
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    /* 토글 스위치 라벨 텍스트 크기 수정 */
    .toggle-switch {
      font-size: 0.56rem;
    }

    /* 모바일 대응 */
    @media (max-width: 768px) {

      .status-badge,
      .action-btn,
      .toggle-switch,
      .data-table td {
        font-size: 0.53rem;
      }
    }

    /* 중복된 스타일 제거하고 더 구체적인 선택자 사용 */
    .data-table td {
      padding: 0.4rem 0.5rem;
      font-size: 0.56rem;
      border-bottom: 1px solid #eee;
      white-space: nowrap;
      height: auto;
      line-height: 1.2;
      vertical-align: middle;
    }

    /* 상태 배지 스타일 */
    .data-table td .status-badge {
      padding: 0.15rem 0.3rem;
      font-size: 0.56rem;
      line-height: 1;
      display: inline-block;
      border-radius: 3px;
    }

    /* 액션 버튼 스타일 */
    .data-table td .action-buttons {
      display: flex;
      gap: 0.3rem;
      align-items: center;
      justify-content: center;
    }

    .data-table td .action-btn,
    .data-table td .approve-btn,
    .data-table td .reject-btn,
    .data-table td .delete-btn,
    .data-table td .complete-btn {
      padding: 0.15rem 0.3rem;
      font-size: 0.56rem !important;
      line-height: 1;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      white-space: nowrap;
    }

    /* 섹션 제목 크기 조정 */
    .section-title {
      font-size: 0.735 rem;
      /* 기존 1.5rem에서 30% 감소 */
      font-weight: 500;
      margin-bottom: 1rem;
      color: #333;
    }

    @media (max-width: 768px) {
      .section-title {
        font-size: 0.91rem;
        /* 기존 1.3rem에서 30% 감소 */
        margin-bottom: 0.8rem;
      }
    }

    /* 관리 칼럼 버튼 중앙 정렬 */
    .data-table td .action-buttons {
      display: flex;
      gap: 0.3rem;
      align-items: center;
      justify-content: center;
    }

    /* 상단 액션 버튼 크기 조정 */
    .user-btn.export-btn,
    .user-btn.logout-btn,
    .user-btn.change-pw-btn {
      padding: 0.35rem 0.56rem;
      font-size: 0.56rem;
    }

    .user-btn.export-btn i,
    .user-btn.logout-btn i,
    .user-btn.change-pw-btn i {
      font-size: 0.7rem;
    }

    @media (max-width: 768px) {

      .user-btn.export-btn,
      .user-btn.logout-btn,
      .user-btn.change-pw-btn {
        padding: 0.25rem 0.4rem;
        font-size: 0.4rem;
      }

      .user-btn.export-btn i,
      .user-btn.logout-btn i,
      .user-btn.change-pw-btn i {
        font-size: 0.5rem;
      }
    }

    /* 테이블 데이터 중앙 정렬 */
    .data-table td,
    .data-table th {
      text-align: center;
      /* 가로 중앙 정렬 */
      vertical-align: middle;
      /* 세로 중앙 정렬 */
    }

    /* 테이블 내부 요소들도 중앙 정렬 유지 */
    .data-table td .status-badge,
    .data-table td .action-buttons,
    .data-table td .toggle-switch {
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 0 auto;
    }

    /* 이미지(전자서명) 중앙 정렬 */
    .data-table td .signature-thumbnail {
      display: block;
      margin: 0 auto;
    }

    /* 전자서명 칼럼 길이 고정 */
    .data-table th.signature-column {
      width: 150px;
      /* 원하는 고정 너비로 설정 */
      overflow: hidden;
      /* 내용이 넘칠 경우 숨김 처리 */
      text-overflow: ellipsis;
      /* 넘치는 텍스트에 대해 생략 부호(...) 표시 */
      white-space: nowrap;
      /* 텍스트 줄 바꿈 방지 */
    }

    /* 공통 버튼 스타일 */
    .button-common,
    .menu-btn,
    .user-btn {
      padding: 0.3rem 0.65rem;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      font-size: 0.8rem;
    }

    .menu-btn {
      background: #f0f1f1;
      margin-right: 0.3rem;
      white-space: nowrap;
    }

    .user-btn {
      background: #f8f9fa;
    }

    .menu-btn.active {
      background: #007bff;
      color: white;
    }

    .user-btn.export-btn {
      background-color: #28a745;
      color: white;
    }

    .user-btn.logout-btn {
      background-color: #dc3545;
      color: white;
    }

    .change-pw-btn {
      background-color: #2ed51f;
      color: white;
    }

    /* 공통 반응형 버튼 스타일 */
    .button-responsive {
      padding: 0.5rem 0.8rem;
      /* 상하 패딩 0.5rem, 좌우 패딩 0.8rem으로 설정 */
      font-size: 0.8rem;
      /* 글자 크기를 0.8rem으로 설정 */
    }

    @media (max-width: 768px) {

      .export-btn,
      .logout-btn,
      .change-pw-btn {
        padding: 0.5rem 0.8rem;
        font-size: 0.8rem;
      }
    }

    /* 테이블 컨테이너 스크롤 설정 */
    .table-container {
      max-height: calc(100vh - 250px);
      /* 헤더와 여유 공간 고려한 높이 */
      overflow-y: auto;
      /* 세로 스크롤 활성화 */
      border: 1px solid #eee;
      border-radius: 4px;
    }

    /* 테이블 헤더 고정 */
    .data-table thead tr {
      position: sticky;
      top: 0;
      background: white;
      z-index: 10;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    /* 스크롤바 스타일링 */
    .table-container::-webkit-scrollbar {
      width: 8px;
    }

    .table-container::-webkit-scrollbar-track {
      background: #f1f1f1;
    }

    .table-container::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 4px;
    }

    .table-container::-webkit-scrollbar-thumb:hover {
      background: #555;
    }

    /* 테이블 행과 셀 스타일 조정 */
    .data-table td,
    .data-table th {
      padding: 1rem;
      font-size: 1.1rem;
      line-height: 1.5;
      vertical-align: middle;
    }

    /* 서명 이미지 크기 조정 */
    .signature-thumbnail {
      width: 30px;           /* 행 높이와 동일하게 설정 */
      height: 30px;          /* 행 높이와 동일하게 설정 */
      object-fit: contain;   /* 이미지 비율 유지하면서 컨테이너에 맞춤 */
      vertical-align: middle;
      cursor: pointer;       /* 클릭 가능 표시 */
    }

    /* 금액 셀 스타일 */
    .amount-cell {
      font-size: 0.77rem;
      text-align: right !important;
      padding-right: 1rem;
      font-family: 'Noto Sans KR', sans-serif;  /* 고딕체 적용 */
      font-weight: 700;  /* 두껍게 설정 */
    }

    /* 상태 뱃지 크기 조정 */
    .status-badge {
      padding: 0.5rem 1rem;
      font-size: 1rem;
    }

    /* 액션 버튼 크기 조정 */
    .action-btn {
      padding: 0.5rem 1rem;
      font-size: 1rem;
      margin: 0.25rem;
    }

    /* 테이블 행과 모든 요소 높이 통일 */
    .data-table tr {
      height: 30px;
    }

    .data-table td,
    .data-table th {
      height: 30px;
      font-size: 0.77rem;
      line-height: 30px;
      vertical-align: middle;
      padding: 0;
      white-space: nowrap;    
      overflow: hidden;       
      text-overflow: ellipsis; 
    }

    /* 이미지 크기 제한 */
    .signature-thumbnail {
      width: 30px;
      height: 30px;
      object-fit: contain;
      vertical-align: middle;
    }

    /* 액션 버튼, 상태 배지 크기 제한 */
    .action-btn,
    .status-badge,
    .transfer-btn {
      height: 20px;
      line-height: 20px;
      padding: 0 0.65rem;
      margin: 0;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      box-sizing: border-box;
    }

    /* 토글 스위치 크기 제한 */
    .toggle-switch {
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-sizing: border-box;
    }

    /* 모든 셀 내부 요소 중앙 정렬 */
    .data-table td > *,
    .data-table th > * {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
    }

    /* 금액 셀 우측 정렬 유지 */
    .amount-cell {
      text-align: right !important;
      padding-right: 0.65rem;
    }

    /* 승인번호, 환불계좌 칼럼 우측 정렬 */
    .data-table td:nth-child(6),  /* 승인번호 칼럼 */
    .data-table td:nth-child(8) { /* 환불계좌 칼럼 */
      text-align: right;
      padding-right: 1rem;  /* 우측 여백 추가 */
    }

    /* 신청인 칼럼의 데이터 글자 굵게 */
    .data-table td:nth-child(3) {
      font-weight: bold;  /* 신청인 칼럼 (3번째 칼럼) */
    }

    /* 승인번호 칼럼의 데이터 숫자 굵게 */
    .data-table td:nth-child(6) {
      font-weight: bold;  /* 승인번호 칼럼 (6번째 칼럼) */
    }

    /* 신청일시와 신청인 칼럼 사이에 여백 추가 */
    .data-table td:nth-child(2) {
      padding-right: 1rem;  /* 신청일시 칼럼의 오른쪽에 여백 추가 */
    }
  </style>
</head>

<body>
  <!-- 로그인 섹션 -->
  <div id="loginSection" class="login-container">
    <form id="loginForm" class="login-form">
      <h2 style="margin-bottom: 1.5rem; text-align: center;">관리자 로그인</h2>
      <div class="form-group">
        <label for="adminId">관리자 ID</label>
        <input type="text" id="adminId" class="form-input" required>
      </div>
      <div class="form-group">
        <label for="password">비밀번호</label>
        <input type="password" id="password" class="form-input" required>
      </div>
      <button type="submit" class="login-btn">로그인</button>
    </form>
  </div>

  <!-- 메인 대시보드 섹션 -->
  <div id="mainSection" class="dashboard">
    <header class="dashboard-header">
      <div class="menu-container">
        <div class="main-menu">
          <button class="menu-btn active" data-section="refund">환불신청관리</button>
          <button class="menu-btn" data-section="coupon">쿠폰사용신청관리</button>
          <button class="menu-btn" data-section="transfer">송금관리</button>
          <button class="menu-btn" data-section="signature">전자서명</button>
          <button class="menu-btn" data-section="refundLedger">환불대장</button>
        </div>

        <!-- 환불금액 요약 박스 추가 -->
        <div class="refund-summary-box">
          <div class="summary-row">
            <span class="summary-label">금일 실시간 환불신청 총액:</span>
            <span id="todayTotal" class="summary-value">0원</span>
          </div>
          <div class="summary-row">
            <div class="date-selector">
              <input type="date" id="refundDate" onchange="updateRefundSummary()">
              <span id="selectedDateTotal" class="summary-value">0원</span>
            </div>
          </div>
        </div>

        <div class="user-actions">
          <button class="user-btn export-btn" onclick="exportToExcel()">
            <i class="fas fa-file-excel"></i> 엑셀저장
          </button>
          <button class="user-btn logout-btn" onclick="logout()">로그아웃</button>
          <button class="user-btn change-pw-btn" onclick="showChangePasswordModal()">비밀번호 변경</button>
        </div>
      </div>
    </header>

    <main class="dashboard-content">
      <!-- 환불신청관리 섹션 -->
      <section id="refund" class="content-section active">
        <h2 class="section-title">환불신청관리</h2>
        <div class="table-container">
          <table class="data-table">
            <thead>
              <tr>
                <th>환불신청번호</th>
                <th>신청일시</th>
                <th>신청인</th>
                <th>이메일</th>
                <th>전화번호</th>
                <th>승인번호</th>
                <th>환불금액</th>
                <th>환불계좌</th>
                <th>환불사유</th>
                <th>전자서명</th>
                <th>처리상태</th>
                <th>관리</th>
                <th>숨김/보이기</th>
              </tr>
            </thead>
            <tbody id="refundTableBody"></tbody>
          </table>
        </div>
      </section>

      <!-- 쿠폰사용신청관리 섹션 -->
      <section id="coupon" class="content-section">
        <h2 class="section-title">쿠폰사용신청관리</h2>
        <div class="table-container">
          <table class="data-table">
            <thead>
              <tr>
                <th>신청일시</th>
                <th>신청인</th>
                <th>전화번호</th>
                <th>쿠폰번호</th>
                <th>사용금액</th>
                <th>처리상태</th>
                <th>관리</th>
              </tr>
            </thead>
            <tbody id="couponTableBody"></tbody>
          </table>
        </div>
      </section>

      <!-- 송금관리 섹션 -->
      <section id="transfer" class="content-section">
        <h2 class="section-title">송금관리</h2>
        <div class="table-container">
          <table class="data-table">
            <thead>
              <tr>
                <th>환불신청번호</th>
                <th>신청일시</th>
                <th>신청인</th>
                <th>이메일</th>
                <th>전화번호</th>
                <th>승인번호</th>
                <th>환불금액</th>
                <th>환불계좌</th>
                <th>처리상태</th>
                <th>송금</th>
              </tr>
            </thead>
            <tbody id="transferTableBody"></tbody>
          </table>
        </div>
      </section>

      <!-- 전자서명 섹션 -->
      <section id="signature" class="content-section">
        <h2 class="section-title">전자서명 관리</h2>
        <div class="search-container">
          <input type="text" id="signatureSearch" placeholder="신용카드승인번호 또는 신청인 이름 입력">
          <button class="submit-button" onclick="searchSignature()">서명자료 검색</button>
        </div>
        <div id="signatureResults"></div>
      </section>

      <!-- 환불대장 섹션 추가 -->
      <section id="refundLedger" class="content-section">
        <h2 class="section-title">환불대장</h2>
        <div class="table-container">
          <table class="data-table">
            <thead>
              <tr>
                <th>환불신청번호</th>
                <th>신청일시</th>
                <th>신청인</th>
                <th>이메일</th>
                <th>전화번호</th>
                <th>승인번호</th>
                <th>환불금액</th>
                <th>환불계좌</th>
                <th>처리상태</th>
                <th>송금시간</th>
              </tr>
            </thead>
            <tbody id="refundLedgerTableBody"></tbody>
          </table>
        </div>
      </section>
    </main>
  </div>

  <!-- 비밀번호 변경 모달 -->
  <div id="passwordModal" class="modal">
    <div class="modal-content">
      <button class="close-btn" onclick="hideChangePasswordModal()">&times;</button>
      <h2 style="margin-bottom: 1.5rem;">비밀번호 변경</h2>
      <form id="changePasswordForm">
        <div class="form-group">
          <label for="currentPassword">현재 비밀번호</label>
          <input type="password" id="currentPassword" class="form-input" required>
        </div>
        <div class="form-group">
          <label for="newPassword">새 비밀번호</label>
          <input type="password" id="newPassword" class="form-input" required>
        </div>
        <div class="form-group">
          <label for="confirmPassword">새 비밀번호 확인</label>
          <input type="password" id="confirmPassword" class="form-input" required>
        </div>
        <button type="submit" class="login-btn">변경하기</button>
      </form>
    </div>
  </div>

  <!-- 서명 조회 모달 -->
  <div id="signatureModal" class="modal">
    <div class="modal-content">
      <h3>전자서명 상세정보</h3>
      <div id="signatureDetails"></div>
      <div class="modal-buttons">
        <button onclick="printSignatureDetails()" class="submit-button">인쇄</button>
        <button onclick="closeSignatureModal()" class="submit-button secondary">닫기</button>
      </div>
    </div>
  </div>

  <script>
    // Firebase 초기화
    const firebaseConfig = {
      apiKey: "AIzaSyAWrSUmZfofRnofVx5LfCPmPoVtTUuy3A8",
      authDomain: "coupon-world-370d1.firebaseapp.com",
      databaseURL: "https://coupon-world-370d1-default-rtdb.firebaseio.com",
      projectId: "coupon-world-370d1",
      storageBucket: "coupon-world-370d1.firebasestorage.app",
      messagingSenderId: "631643024069",
      appId: "1:631643024069:web:f35111184e686bc980deac",
      measurementId: "G-1CJ2Z8D8NX"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // 관리자 계정 정보
    const adminCredentials = {
      'mainadmin': 'vlfl940325',
      'stepadmin': 'step1111',
      'sales': 'sales1111'
    };

    // 유틸리티 함수
    const utils = {
      formatDate(timestamp) {
        const date = new Date(timestamp);
        return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
      },
      getStatusText(status) {
        return {
          pending: '대기중',
          approved: '승인됨',
          rejected: '반려됨',
          completed: '환불처리완료',
          cancelled: '취소'
        }[status] || '알 수 없음';
      }
    };

    // 로그인 처리
    document.getElementById('loginForm').addEventListener('submit', function (e) {
      e.preventDefault();
      const adminId = document.getElementById('adminId').value;
      const password = document.getElementById('password').value;

      if (adminCredentials[adminId] === password) {
        sessionStorage.setItem('adminId', adminId);
        document.getElementById('loginSection').style.display = 'none';
        document.getElementById('mainSection').style.display = 'block';

        // 로그인 성공 후 레이아웃 초기화
        setTimeout(() => {
          loadSectionData('refund');
          setupRealtimeUpdates();
          adjustLayout();
        }, 100);
      } else {
        alert('아이디 또는 비밀번호가 올바르지 않습니다.');
      }
    });

    // 데이터 로드 및 테이블 업데이트
    function updateTable(type, data) {
      const tableBody = document.getElementById(`${type}TableBody`);
      if (!tableBody) return;

      if (!data || Object.keys(data).length === 0) {
        const colSpan = type === 'refund' ? 13 : (type === 'coupon' ? 7 : 6);
        tableBody.innerHTML = `<tr><td colspan="${colSpan}" class="no-data">데이터가 없습니다.</td></tr>`;
        return;
      }

      const rows = Object.entries(data)
        .sort((a, b) => new Date(b[1].timestamp) - new Date(a[1].timestamp))
        .map(([key, item]) => {
          const statusBadge = `<span class="status-badge status-${item.status}">${utils.getStatusText(item.status)}</span>`;
          let actionButtons = '';

          if (type === 'refund') {
            actionButtons = `
              <div class="action-buttons">
                <button class="action-btn approve-btn" onclick="updateStatus('${key}', '${type}', 'approved')">승인</button>
                <button class="action-btn reject-btn" onclick="updateStatus('${key}', '${type}', 'rejected')">반려</button>
                <button class="action-btn complete-btn" onclick="updateStatus('${key}', '${type}', 'completed')">송금완료</button>
              </div>
            `;
          } else {
            actionButtons = `
              <div class="action-buttons">
                <button class="action-btn approve-btn" onclick="updateStatus('${key}', '${type}', 'approved')">승인</button>
                <button class="action-btn reject-btn" onclick="updateStatus('${key}', '${type}', 'rejected')">반려</button>
              </div>
            `;
          }

          if (type === 'refund') {
            const bankInfo = item.bankInfo || {};
            const refundAmount = item.refundAmount || 0;
            const isHidden = item.isHidden || false;

            const statusClass = item.status === 'cancelled' ? 'cancelled' : item.status;
            const statusBadge = `<span class="status-badge status-${statusClass}">${getStatusText(item.status)}</span>`;

            const toggleSwitch = `
              <label class="toggle-switch">
                <input type="checkbox" ${isHidden ? 'checked' : ''} 
                  onchange="toggleRowVisibility('${key}', this.checked)">
                <span class="toggle-slider"></span>
              </label>
            `;

            return `
              <tr class="${isHidden ? 'hidden-row' : ''}" data-key="${key}">
                <td>${item.applicationNumber || '-'}</td>
                <td>${utils.formatDate(item.timestamp)}</td>
                <td>${item.userName || ''}</td>
                <td>${item.userEmail || ''}</td>
                <td>${item.userPhone || ''}</td>
                <td>${item.cardApproval || ''}</td>
                <td class="amount-cell">${refundAmount.toLocaleString()}원</td>
                <td>${getBankNameKorean(item.bankInfo?.bankName || '')} ${(item.bankInfo?.accountNumber || '')} (${item.bankInfo?.accountHolder || ''})</td>
                <td>${getRefundReasonText(item.refundReason)}</td>
                <td>${item.signature ? `<img src="${item.signature}" alt="전자서명" class="signature-thumbnail" onclick="showSignatureModal('${item.signature}')" style="max-width: 100px; height: auto;">` : '-'}</td>
                <td>${statusBadge}</td>
                <td>${actionButtons}</td>
                <td>${toggleSwitch}</td>
              </tr>
            `;
          } else if (type === 'coupon') {
            return `
              <tr>
                <td>${utils.formatDate(item.timestamp)}</td>
                <td>${item.userName || ''}</td>
                <td>${item.userPhone || ''}</td>
                <td>${item.couponNumber || ''}</td>
                <td class="amount-cell">${(item.amount || 0).toLocaleString()}원</td>
                <td>${statusBadge}</td>
                <td>${actionButtons}</td>
              </tr>
            `;
          }
          return '';
        }).join('');

      tableBody.innerHTML = rows;
    }

    // 상태 업데이트 함수
    async function updateStatus(key, type, newStatus) {
      const currentAdmin = sessionStorage.getItem('adminId');

      // 권한 크
      if (currentAdmin !== 'mainadmin' && currentAdmin !== 'admin') {
        alert('처리 권한이 없습니다.');
        return;
      }

      try {
        await db.ref(`applications/${type}/${key}`).update({
          status: newStatus,
          processedAt: new Date().toISOString(),
          processedBy: currentAdmin
        });

        const actionText = newStatus === 'pending' ? '초기화' :
          newStatus === 'approved' ? '승인' :
            newStatus === 'completed' ? '완료' : '반려';

        const message = newStatus === 'completed' ?
          '환불이 완료되었습니다.' :
          `${type === 'coupon' ? '쿠폰' : '환불'} 신청이 ${actionText}되었습니다.`;

        alert(message);
      } catch (error) {
        console.error('상태 업데이트 실패:', error);
        alert('처리 중 오류가 발생했습니다.');
      }
    }

    // 섹션 데이터 로드
    function loadSectionData(type) {
      db.ref(`applications/${type}`).once('value')
        .then(snapshot => {
          updateTable(type, snapshot.val());
        })
        .catch(error => {
          console.error('데이터 로드 실패:', error);
          alert('데이터 로드 중 오류가 발��했습니다.');
        });
    }

    // 실시간 업데이트 설정 함수 수정
    function setupRealtimeUpdates() {
      const refundRef = db.ref('applications/refund');
      
      refundRef.on('value', snapshot => {
        try {
          const data = snapshot.val();
          const activeSection = document.querySelector('.content-section.active');
          
          if (activeSection && activeSection.id) {
            switch (activeSection.id) {
              case 'transfer':
                const approvedData = {};
                if (data) {
                  Object.entries(data).forEach(([key, value]) => {
                    if (value.status === 'approved') {
                      approvedData[key] = value;
                    }
                  });
                }
                updateTransferTable(approvedData);
                break;
                
              case 'refund':
                updateTable('refund', data);
                break;
                
              case 'refundLedger':
                updateRefundLedgerTable(data);
                break;
            }
          }
          
          // 환불대장 데이터는 항상 업데이트
          const refundLedgerSection = document.getElementById('refundLedger');
          if (refundLedgerSection) {
            updateRefundLedgerTable(data);
          }
        } catch (error) {
          console.error('데이터 업데이트 중 오류 발생:', error);
        }
      });

      // 다른 섹션들의 실시간 업데이트
      ['coupon', 'inquiry'].forEach(type => {
        db.ref(`applications/${type}`).on('value', snapshot => {
          try {
            const section = document.getElementById(type);
            if (section && section.classList && section.classList.contains('active')) {
              updateTable(type, snapshot.val());
            }
          } catch (error) {
            console.error(`${type} 데이터 업데이트 중 오류 발생:`, error);
          }
        });
      });
    }

    // 로그아웃 처리
    function logout() {
      if (confirm('로그아웃 하시겠니까?')) {
        sessionStorage.removeItem('adminId');
        window.location.reload();
      }
    }

    // 비밀번호 변경 모달 제어
    function showChangePasswordModal() {
      document.getElementById('passwordModal').style.display = 'block';
    }

    function hideChangePasswordModal() {
      document.getElementById('passwordModal').style.display = 'none';
      document.getElementById('changePasswordForm').reset();
    }

    // 비밀번호 변경 처리
    document.getElementById('changePasswordForm').addEventListener('submit', function (e) {
      e.preventDefault();
      const currentPassword = document.getElementById('currentPassword').value;
      const newPassword = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      const adminId = sessionStorage.getItem('adminId');

      if (adminCredentials[adminId] !== currentPassword) {
        alert('현재 비밀번호가 올바르지 않습니다.');
        return;
      }

      if (newPassword !== confirmPassword) {
        alert('새 비밀번호가 일치하지 않습니다.');
        return;
      }

      adminCredentials[adminId] = newPassword;
      alert('비밀번호가 변경되었습니다.');
      hideChangePasswordModal();
    });

    // 메뉴 전환 이벤트 리스너 수정
    document.querySelectorAll('.menu-btn').forEach(button => {
      button.addEventListener('click', function () {
        const sectionId = this.dataset.section;

        document.querySelectorAll('.menu-btn').forEach(btn => btn.classList.remove('active'));
        this.classList.add('active');

        document.querySelectorAll('.content-section').forEach(section => {
          section.classList.remove('active');
        });
        document.getElementById(sectionId).classList.add('active');

        // 섹션별 데이터 로드
        if (sectionId === 'refundLedger') {
          db.ref('applications/refund').once('value')
            .then(snapshot => {
              updateRefundLedgerTable(snapshot.val());
            });
        } else if (sectionId === 'transfer') {
          db.ref('applications/refund').once('value')
            .then(snapshot => {
              const data = snapshot.val();
              const approvedData = {};
              if (data) {
                Object.entries(data).forEach(([key, value]) => {
                  if (value.status === 'approved') {
                    approvedData[key] = value;
                  }
                });
              }
              updateTransferTable(approvedData);
            });
        } else {
          loadSectionData(sectionId);
        }
      });
    });

    // 초기화 함수 수정
    document.addEventListener('DOMContentLoaded', function () {
      const adminId = sessionStorage.getItem('adminId');
      if (adminId) {
        document.getElementById('loginSection').style.display = 'none';
        document.getElementById('mainSection').style.display = 'block';

        setTimeout(() => {
          // 환불신청 데이터 로드
          loadSectionData('refund');
          
          // 송금관리 데이터 초기 로드
          db.ref('applications/refund').once('value')
            .then(snapshot => {
              const data = snapshot.val();
              const approvedData = {};
              if (data) {
                Object.entries(data).forEach(([key, value]) => {
                  if (value.status === 'approved') {
                    approvedData[key] = value;
                  }
                });
              }
              updateTransferTable(approvedData);
            });
          
          setupRealtimeUpdates();
          adjustLayout();
        }, 100);
      } else {
        document.getElementById('loginSection').style.display = 'flex';
        document.getElementById('mainSection').style.display = 'none';
      }
    });

    // 세션 만료 시간 설정
    const SESSION_TIMEOUT = 3600000; // 1시간
    sessionStorage.setItem('loginTime', Date.now());

    // 주기적으 세션 체크
    setInterval(() => {
      const loginTime = sessionStorage.getItem('loginTime');
      if (Date.now() - loginTime > SESSION_TIMEOUT) {
        alert('세션이 만료되었습니다. 다시 로그인해주세요.');
        logout();
      }
    }, 60000); // 1분마다 체크

    // 엑셀 내보내기 함수
    function exportToExcel() {
      const currentSection = document.querySelector('.content-section.active');
      const type = currentSection.id;
      const timestamp = new Date().toISOString().slice(0, 10);

      // 이블 데이터 가져오기
      const table = currentSection.querySelector('.data-table');
      const ws = XLSX.utils.table_to_sheet(table);

      // 열 너비 설정
      const colWidths = [];
      table.querySelectorAll('tr:first-child td, tr:first-child th').forEach(() => {
        colWidths.push({ wch: 15 }); // 기본  너비
      });
      ws['!cols'] = colWidths;

      // 워크북 생성
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Sheet1');

      // 파일명 설정
      let fileName = '';
      switch (type) {
        case 'coupon':
          fileName = `쿠폰사용신청_${timestamp}.xlsx`;
          break;
        case 'refund':
          fileName = `환불신청_${timestamp}.xlsx`;
          break;
        case 'inquiry':
          fileName = `문의사항_${timestamp}.xlsx`;
          break;
      }

      // 엑셀 파일 저장
      try {
        XLSX.writeFile(wb, fileName);
      } catch (error) {
        console.error('엑셀 파일 생성 중 오류:', error);
        alert('엑셀 파일 생성 중 오류가 발생했습니다.');
      }
    }

    // 날짜 포맷 함수 (엑셀용)
    function formatDateForExcel(timestamp) {
      const date = new Date(timestamp);
      return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
    }

    // 테이블 업데이트 수 수정 (기존 updateTable 함수에 추가)
    function updateTable(type, data) {
      const tableBody = document.getElementById(`${type}TableBody`);
      if (!tableBody) return;

      if (!data || Object.keys(data).length === 0) {
        const colSpan = type === 'refund' ? 13 : (type === 'coupon' ? 7 : 6);
        tableBody.innerHTML = `<tr><td colspan="${colSpan}" class="no-data">데이터가 없습니다.</td></tr>`;
        return;
      }

      const rows = Object.entries(data)
        .sort((a, b) => new Date(b[1].timestamp) - new Date(a[1].timestamp))
        .map(([key, item]) => {
          const statusBadge = `<span class="status-badge status-${item.status}">${utils.getStatusText(item.status)}</span>`;
          let actionButtons = '';

          if (type === 'refund') {
            actionButtons = `
              <div class="action-buttons">
                <button class="action-btn approve-btn" onclick="updateStatus('${key}', '${type}', 'approved')">승인</button>
                <button class="action-btn reject-btn" onclick="updateStatus('${key}', '${type}', 'rejected')">반려</button>
                <button class="action-btn complete-btn" onclick="updateStatus('${key}', '${type}', 'completed')">송금완료</button>
              </div>
            `;
          } else {
            actionButtons = `
              <div class="action-buttons">
                <button class="action-btn approve-btn" onclick="updateStatus('${key}', '${type}', 'approved')">승인</button>
                <button class="action-btn reject-btn" onclick="updateStatus('${key}', '${type}', 'rejected')">반려</button>
              </div>
            `;
          }

          if (type === 'refund') {
            const bankInfo = item.bankInfo || {};
            const refundAmount = item.refundAmount || 0;
            const isHidden = item.isHidden || false;

            const statusClass = item.status === 'cancelled' ? 'cancelled' : item.status;
            const statusBadge = `<span class="status-badge status-${statusClass}">${getStatusText(item.status)}</span>`;

            const toggleSwitch = `
              <label class="toggle-switch">
                <input type="checkbox" ${isHidden ? 'checked' : ''} 
                  onchange="toggleRowVisibility('${key}', this.checked)">
                <span class="toggle-slider"></span>
              </label>
            `;

            return `
              <tr class="${isHidden ? 'hidden-row' : ''}" data-key="${key}">
                <td>${item.applicationNumber || '-'}</td>
                <td>${utils.formatDate(item.timestamp)}</td>
                <td>${item.userName || ''}</td>
                <td>${item.userEmail || ''}</td>
                <td>${item.userPhone || ''}</td>
                <td>${item.cardApproval || ''}</td>
                <td class="amount-cell">${refundAmount.toLocaleString()}원</td>
                <td>${getBankNameKorean(item.bankInfo?.bankName || '')} ${(item.bankInfo?.accountNumber || '')} (${item.bankInfo?.accountHolder || ''})</td>
                <td>${getRefundReasonText(item.refundReason)}</td>
                <td>${item.signature ? `<img src="${item.signature}" alt="전자서명" class="signature-thumbnail" onclick="showSignatureModal('${item.signature}')" style="max-width: 100px; height: auto;">` : '-'}</td>
                <td>${statusBadge}</td>
                <td>${actionButtons}</td>
                <td>${toggleSwitch}</td>
              </tr>
            `;
          } else if (type === 'coupon') {
            return `
              <tr>
                <td>${utils.formatDate(item.timestamp)}</td>
                <td>${item.userName || ''}</td>
                <td>${item.userPhone || ''}</td>
                <td>${item.couponNumber || ''}</td>
                <td class="amount-cell">${(item.amount || 0).toLocaleString()}원</td>
                <td>${statusBadge}</td>
                <td>${actionButtons}</td>
              </tr>
            `;
          }
          return '';
        }).join('');

      tableBody.innerHTML = rows;
    }

    // Firebase 데이터 연동
    function initializeData() {
      // 실시간 데이터베이스 참조
      const refundRef = firebase.database().ref('applications/refund');
      const couponRef = firebase.database().ref('applications/coupon');

      // 환불신청 데이터 감시
      refundRef.on('value', (snapshot) => {
        console.log('불신청 데이터:', snapshot.val()); // 디버깅용
        updateTable('refund', snapshot.val());
      }, (error) => {
        console.error('환불신청 데이터 로드 중 오류:', error);
      });

      // 쿠폰사용신청 데이터 감시
      couponRef.on('value', (snapshot) => {
        updateTable('coupon', snapshot.val());
      }, (error) => {
        console.error('쿠폰사용신청 데이터 로드 중 오류:', error);
      });
    }

    // 유틸리티 함수들
    function getStatusText(status) {
      return {
        'pending': '신청접수',
        'approved': '승인',
        'rejected': '반려',
        'completed': '송금완료',
        'cancelled': '취소'
      }[status] || status;
    }

    function formatDate(timestamp) {
      if (!timestamp) return '';
      const date = new Date(timestamp);
      return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
    }

    // 페이지 로드 시 초기화
    document.addEventListener('DOMContentLoaded', () => {
      initializeData();
    });



    // 환불금액 요약 업데이트 함수 수정
    function updateRefundSummary() {
      const selectedDate = document.getElementById('refundDate').value;

      // 오늘 날짜를 한국 시간 기준으로 설정
      const now = new Date();
      const kstNow = new Date(now.getTime() + (9 * 60 * 60 * 1000));
      const today = kstNow.toISOString().split('T')[0];

      db.ref('applications/refund').once('value')
        .then(snapshot => {
          const refundData = snapshot.val() || {};
          let selectedDateTotal = 0;
          let todayTotal = 0;

          Object.values(refundData).forEach(item => {
            // 타임스탬프를 한국 시간으로 변환
            const itemDate = new Date(item.timestamp);
            const kstDate = new Date(itemDate.getTime() + (9 * 60 * 60 * 1000));
            const itemDateStr = kstDate.toISOString().split('T')[0];

            const amount = parseInt(item.refundAmount) || 0;

            // 취소 상태가 아닌 신청건만 합계에 포함
            if (item.status !== 'cancelled') {
              // 선택된 날짜의 합계 계산
              if (itemDateStr === selectedDate) {
                selectedDateTotal += amount;
              }

              // 오늘 날짜의 합계 계산 (한국 시간 기준)
              if (itemDateStr === today) {
                todayTotal += amount;
              }
            }
          });

          // 결과 표시
          document.getElementById('selectedDateTotal').textContent =
            selectedDateTotal.toLocaleString() + '원';
          document.getElementById('todayTotal').textContent =
            todayTotal.toLocaleString() + '원';
        });
    }

    // 실시간 데이터 업데이트를 위한 리스너 추가
    function initializeData() {
      const refundRef = firebase.database().ref('applications/refund');

      refundRef.on('value', (snapshot) => {
        updateRefundSummary();
      });
    }

    // 데이터 삭제 함수 추가
    async function deleteData(key, type) {
      // mainadmin 권한 ���크
      if (sessionStorage.getItem('adminId') !== 'mainadmin') {
        alert('삭제 권한이 없습니다.');
        return;
      }

      // 삭제 확인
      const confirmMessage = {
        'coupon': '쿠폰사용신청',
        'refund': '환불신청',
        'inquiry': '문의사항'
      };

      if (!confirm(`선택한 ${confirmMessage[type]} 데이터를 삭제하시겠습니까?\n삭제 데이터는 복구할  없습니다.`)) {
        return;
      }

      try {
        // Firebase에서 데이터 삭제
        await db.ref(`applications/${type}/${key}`).remove();

        // 삭제 로그 기록 (선택사항)
        await db.ref('deleteLogs').push({
          type: type,
          dataKey: key,
          deletedBy: sessionStorage.getItem('adminId'),
          deletedAt: new Date().toISOString()
        });

        alert('데이터가 삭제되었습니다.');

        // 환불신청 데이터인 경 요약 정보 업데이
        if (type === 'refund') {
          updateRefundSummary();
        }
      } catch (error) {
        console.error('데이터 삭제 중 오류:', error);
        alert('데이터 삭제 중 오류가 발생했습니다.');
      }
    }

    // 화면 크기 변경 시 레이아웃 조정 함수 수정
    function adjustLayout() {
      const header = document.querySelector('.dashboard-header');
      const content = document.querySelector('.dashboard-content');
      if (header && content) {
        const headerHeight = header.offsetHeight;
        content.style.marginTop = `${headerHeight}px`;
        content.style.height = `calc(100vh - ${headerHeight}px)`;
      }
    }

    // ���트 리스너 설정
    document.addEventListener('DOMContentLoaded', function () {
      adjustLayout(); // 초기 로드 시 실행

      // 데이터 로드 후에도 레이아웃 조정
      ['coupon', 'refund', 'inquiry'].forEach(type => {
        db.ref(`applications/${type}`).on('value', () => {
          setTimeout(adjustLayout, 100); // ���이터 렌더링 후 레이아웃 조정
        });
      });
    });
    

    // 화면 크기 변경 시 레이아웃 조정
    window.addEventListener('resize', adjustLayout);

    // 메뉴 전환 시 레이아웃 조정
    document.querySelectorAll('.menu-btn').forEach(button => {
      button.addEventListener('click', function () {
        setTimeout(adjustLayout, 100); // 메뉴 전환 후 레이아웃 조정
      });
    });
    

    // 행 숨김/보이기 토글 함수 추가
    async function toggleRowVisibility(key, isHidden) {
      try {
        await db.ref(`applications/refund/${key}`).update({
          isHidden: isHidden
        });

        const row = document.querySelector(`tr[data-key="${key}"]`);
        if (row) {
          if (isHidden) {
            row.classList.add('hidden-row');
          } else {
            row.classList.remove('hidden-row');
          }
        }
      } catch (error) {
        console.error('상태 업데이트 중 오류:', error);
        alert('처리 중 오류가 발생했습니다.');
      }
    }

    // 전자서명 검색 함수
    async function searchSignature() {
      const searchValue = document.getElementById('signatureSearch').value;
      if (!searchValue) {
        alert('검색어를 입력해주세요.');
        return;
      }

      const refundRef = firebase.database().ref('applications/refund');
      const snapshot = await refundRef.once('value');
      const results = [];

      snapshot.forEach(child => {
        const data = child.val();
        if (data.cardApproval === searchValue || data.userName === searchValue) {
          results.push({ key: child.key, ...data });
        }
      });

      showSignatureModal(results);
    }

    // 서명 모달 표시
    function showSignatureModal(results) {
      const modal = document.getElementById('signatureModal');
      const details = document.getElementById('signatureDetails');

      if (results.length === 0) {
        alert('검색 결과가 없습니다.');
        return;
      }

      let html = results.map(data => `
        <div class="signature-detail-item">
          <p><strong>환불신청번호:</strong> ${data.applicationNumber}</p>
          <p><strong>신청일시:</strong> ${formatDate(data.timestamp)}</p>
          <p><strong>신청인:</strong> ${data.userName}</p>
          <p><strong>메일:</strong> ${data.userEmail}</p>
          <p><strong>승인번호:</strong> ${data.cardApproval}</p>
          <p><strong>환불금액:</strong> ${data.refundAmount.toLocaleString()}��</p>
          <p><strong>환불계좌:</strong> ${getBankNameKorean(data.bankInfo.bankName)} ${data.bankInfo.accountNumber}</p>
          ${data.signature ? `<img src="${data.signature}" alt="전자서명" class="signature-image">` : '<p>서명 없음</p>'}
          <hr>
        </div>
      `).join('');

      details.innerHTML = html;
      modal.style.display = 'flex';
    }

    // 서명 데이터 인쇄
    function printSignatureDetails() {
      const printWindow = window.open('', '', 'width=800,height=600');
      const content = document.getElementById('signatureDetails').innerHTML;

      printWindow.document.write(`
        <html>
          <head>
            <title>전자서명 상세��보</title>
            <style>
              body { padding: 20px; }
              .signature-detail-item { margin-bottom: 20px; }
              .signature-image { max-width: 100%; }
            </style>
          </head>
          <body>
            <h2>전자서명 상세정보</h2>
            ${content}
          </body>
        </html>
      `);

      printWindow.document.close();
      printWindow.focus();
      printWindow.print();
      printWindow.close();
    }

    // 서명 모달 닫기 함수
    function closeSignatureModal() {
      const modal = document.getElementById('signatureModal');
      modal.style.display = 'none';
    }

    // 모달 외부 클릭 시 닫기
    window.onclick = function (event) {
      const modal = document.getElementById('signatureModal');
      if (event.target === modal) {
        modal.style.display = 'none';
      }
    }

    // 핀치 줌 기능 추가
    let scale = 1;
    const maxScale = 3; // 최대 확대 비율
    const minScale = 0.5; // 최소 축소 비율

    document.addEventListener('gesturestart', function (e) {
      e.preventDefault(); // 기본 제스처 동작 방지
    });

    document.addEventListener('gesturechange', function (e) {
      e.preventDefault(); // 기본 제스처 동작 방지
      scale = Math.min(maxScale, Math.max(minScale, scale * e.scale));
      document.body.style.transform = `scale(${scale})`;
      document.body.style.transformOrigin = '0 0'; // 변환 기준점 설정
    });

    document.addEventListener('gestureend', function (e) {
      e.preventDefault(); // 기본 제스처 동작 방지
    });

    // 환불 신청 폼 제출 시 전자서명 모달 표시
    document.getElementById('refundForm').addEventListener('submit', function (e) {
      e.preventDefault(); // 기본 제출 동작 방지
      showSignatureModal(); // 전자서명 모달 표시
    });

    // 전자서명 모달 표시 함수
    function showSignatureModal() {
      document.getElementById('signatureModal').style.display = 'block'; // 모달 표시
    }

    // 전자서명 모달 숨기기 함수
    function hideSignatureModal() {
      document.getElementById('signatureModal').style.display = 'none'; // 모달 숨김
    }

    // 서명 저장 버튼 클릭 시 처리
    document.getElementById('saveSignature').addEventListener('click', async function () {
      // 서명 데이터 처리 및 Firebase에 저장하는 로직 추가
      const signatureData = signaturePad.toDataURL(); // 서명 데이터를 데이터 URL로 변환
      // Firebase에 서명 데이터 저장 로직 추가
      // ...
      hideSignatureModal(); // 모달 숨김
    });

    // 은행명 매핑 함수 수정
    function getBankNameKorean(engName) {
      const bankNames = {
        'kb': '국민은행',
        'shinhan': '신한은행',
        'woori': '우리은행',
        'keb': '하나은행',
        'hana': '하나은행',
        'ibk': '기업은행',
        'nh': '농협은행',
        'nonghyup': '농협은행',
        'sc': 'SC제일은행',
        'city': '씨티은행',
        'dgb': '대구은행',
        'bnk': '부산은행',
        'kjb': '광주은행',
        'kwangju': '광주은행',
        'jbb': '전북은행',
        'jeju': '제주은행',
        'post': '우체국',
        'k': '케이뱅크',
        'kakao': '카카오뱅크',
        'toss': '토스뱅크',
        'sh': '신한은행',
        'standard': 'SC제일은행',
        'kn': '경남은행',
        'knb': '경남은행',
        'kj': '광주은행'
      };
      return bankNames[engName.toLowerCase()] || engName;
    }

    // 송금관리 테이블 업데이트 함수 수정
    function updateTransferTable(data) {
      const tableBody = document.getElementById('transferTableBody');
      if (!tableBody) return;

      if (!data || Object.keys(data).length === 0) {
        tableBody.innerHTML = '<tr><td colspan="10" class="no-data">데이터가 없습니다.</td></tr>';
        return;
      }

      const rows = Object.entries(data)
        .filter(([_, item]) => item.status === 'approved' || item.status === 'transfer') // 승인됨 또는 송금처리된 데이터만 표시
        .sort((a, b) => new Date(b[1].timestamp) - new Date(a[1].timestamp))
        .map(([key, item]) => {
          const statusBadge = `<span class="status-badge status-${item.status}">${item.status === 'transfer' ? '송금처리' : utils.getStatusText(item.status)}</span>`;
          
          return `
            <tr>
              <td>${item.applicationNumber || '-'}</td>
              <td>${utils.formatDate(item.timestamp)}</td>
              <td>${item.userName || ''}</td>
              <td>${item.userEmail || ''}</td>
              <td>${item.userPhone || ''}</td>
              <td>${item.cardApproval || ''}</td>
              <td class="amount-cell">${(item.refundAmount || 0).toLocaleString()}원</td>
              <td>${getBankNameKorean(item.bankInfo?.bankName || '')} ${(item.bankInfo?.accountNumber || '')} (${item.bankInfo?.accountHolder || ''})</td>
              <td>${statusBadge}</td>
              <td>
                ${item.status === 'approved' ? 
                  `<button class="action-btn transfer-btn" onclick="processTransfer('${key}')">송금</button>` : 
                  utils.formatDate(item.transferredAt)}
              </td>
            </tr>
          `;
        }).join('');

      tableBody.innerHTML = rows;
    }

    // 송금 처리 함수 수정
    async function processTransfer(key) {
      try {
        const transferredAt = new Date().toISOString();
        const refRef = db.ref(`applications/refund/${key}`);
        
        // 현재 데이터 가져오기
        const snapshot = await refRef.once('value');
        const data = snapshot.val();
        
        if (!data) {
          throw new Error('데이터를 찾을 수 없습니다.');
        }

        // SMS 발송
        await sendSMS(data.userPhone, `귀하의 환불신청계좌로 환불금액을 입금합니다.`);
        
        // 상태 업데이트
        await refRef.update({
          status: 'completed', // 송금완료 상태로 변경
          transferredAt: transferredAt
        });

        alert('송금처리가 완료되었습니다.');
      } catch (error) {
        console.error('송금처리 중 오류:', error);
        alert('송금처리 중 오류가 발생했습니다.');
      }
    }

    // SMS 발송 함수 (실제 SMS 발송 서비스와 연동 필요)
    async function sendSMS(phone, message) {
      // 여기에 실제 SMS 발송 로직 구현
      console.log(`SMS sent to ${phone}: ${message}`);
    }

    // 환불대장 테이블 업데이트 함수 수정
    function updateRefundLedgerTable(data) {
      const tableBody = document.getElementById('refundLedgerTableBody');
      if (!tableBody) return;

      if (!data || Object.keys(data).length === 0) {
        tableBody.innerHTML = '<tr><td colspan="10" class="no-data">데이터가 없습니다.</td></tr>';
        return;
      }

      const rows = Object.entries(data)
        .filter(([_, item]) => item.status === 'completed' && item.transferredAt) // 송금완료 상태이고 송금시간이 있는 데이터만 필터링
        .sort((a, b) => new Date(b[1].transferredAt) - new Date(a[1].transferredAt)) // 송금시간 기준으로 정렬
        .map(([key, item]) => {
          const statusBadge = `<span class="status-badge status-${item.status}">${utils.getStatusText(item.status)}</span>`;
          
          return `
            <tr>
              <td>${item.applicationNumber || '-'}</td>
              <td>${utils.formatDate(item.timestamp)}</td>
              <td>${item.userName || ''}</td>
              <td>${item.userEmail || ''}</td>
              <td>${item.userPhone || ''}</td>
              <td>${item.cardApproval || ''}</td>
              <td class="amount-cell">${(item.refundAmount || 0).toLocaleString()}원</td>
              <td>${getBankNameKorean(item.bankInfo?.bankName || '')} ${(item.bankInfo?.accountNumber || '')} (${item.bankInfo?.accountHolder || ''})</td>
              <td>${statusBadge}</td>
              <td>${utils.formatDate(item.transferredAt)}</td>
            </tr>
          `;
        }).join('');

      tableBody.innerHTML = rows;
    }

    // 환불사유 텍스트 변환 함수 수정
    function getRefundReasonText(reason) {
      if (!reason) return '미지정';  // reason이 undefined나 null인 경우 처리
      
      const reasons = {
        'change_mind': '단순변심',
        'dissatisfaction': '서비스불만',
        'other': '기타'
      };
      return reasons[reason] || '미지정';
    }

    // 이벤트 리스너 설정
    document.addEventListener('DOMContentLoaded', () => {
      setupRealtimeUpdates();

      // 환불사유 선택에 따른 기타사유 입력란 표시/숨김 처리
      const refundReasonSelect = document.getElementById('refundReason');
      if (refundReasonSelect) {
        refundReasonSelect.addEventListener('change', function() {
          const otherReasonInput = document.getElementById('otherReasonInput');
          if (otherReasonInput) {
            otherReasonInput.style.display = this.value === 'other' ? 'block' : 'none';
            otherReasonInput.required = this.value === 'other';
          }
        });
      }

      // 다른 이벤트 리스너들도 동일한 방식으로 처리
      const searchApplication = document.getElementById('searchApplication');
      if (searchApplication) {
        searchApplication.addEventListener('click', async () => {
          // ... existing search application code ...
        });
      }

      // 기존의 다른 이벤트 리스너들도 유지
    });
  </script>
</body>

</html>